apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: grafana
  namespace: monitoring
spec:
  chart:
    spec:
      chart: grafana
      version: 7.0.9
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
  interval: 15m
  timeout: 5m
  releaseName: grafana
  values:
    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        kubernetes.io/ingress.class: nginx
        kubernetes.io/tls-acme: 'true'
      hosts:
        - grafana.domain.com
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
        - name: Prometheus
          type: prometheus
          url: http://prometheus-server.monitoring.svc.cluster.local
          access: proxy
          isDefault: true
        - name: Loki
          type: loki
          url: http://loki-gateway.monitoring.svc.cluster.local
          access: proxy
          isDefault: false
    dashboards:
      default:
        test-dashboard:
          json: |
            {
              "annotations": {
                "list": [
                  {
                    "builtIn": 1,
                    "datasource": {
                      "type": "grafana",
                      "uid": "-- Grafana --"
                    },
                    "enable": true,
                    "hide": true,
                    "iconColor": "rgba(0, 211, 255, 1)",
                    "name": "Annotations & Alerts",
                    "type": "dashboard"
                  }
                ]
              },
              "editable": true,
              "fiscalYearStartMonth": 0,
              "graphTooltip": 0,
              "id": 2,
              "links": [],
              "liveNow": false,
              "panels": [
                {
                  "datasource": {
                    "type": "loki",
                    "uid": "P8E80F9AEF21F6940"
                  },
                  "gridPos": {
                    "h": 8,
                    "w": 12,
                    "x": 0,
                    "y": 0
                  },
                  "id": 1,
                  "options": {
                    "dedupStrategy": "none",
                    "enableLogDetails": true,
                    "prettifyLogMessage": false,
                    "showCommonLabels": false,
                    "showLabels": false,
                    "showTime": false,
                    "sortOrder": "Descending",
                    "wrapLogMessage": false
                  },
                  "targets": [
                    {
                      "datasource": {
                        "type": "loki",
                        "uid": "P8E80F9AEF21F6940"
                      },
                      "editorMode": "builder",
                      "expr": "{container=\"grafana\"} |= ``",
                      "queryType": "range",
                      "refId": "A"
                    }
                  ],
                  "title": "Panel Title",
                  "type": "logs"
                }
              ],
              "refresh": "",
              "schemaVersion": 38,
              "style": "dark",
              "tags": [],
              "templating": {
                "list": []
              },
              "time": {
                "from": "now-6h",
                "to": "now"
              },
              "timepicker": {},
              "timezone": "",
              "title": "Test dashboard from values",
              "uid": "b6566d77-f07d-4f1e-8f91-9d753479c48f",
              "version": 1,
              "weekStart": ""
            }
